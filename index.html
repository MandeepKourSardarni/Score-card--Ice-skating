<!DOCTYPE html>
<html>
<head>
<title>Ice Skating Short Track Ranking Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>

/* BACKGROUND */
body {
    margin:0;
    padding:0;
    font-family:'Segoe UI',Arial,sans-serif;
    color:white;
}

.bg {
    background-image:url("https://video.cgtn.com/news/2021-01-23/Ice-surface-on-Beijing-2022-speed-skating-venue-finalized-XhM4M7DJ9C/video/428a494ca70b4bf6992c02980728dc40/428a494ca70b4bf6992c02980728dc40.jpg");
    background-size:cover;
    background-position:center;
    background-attachment:fixed;
    position:fixed;
    inset:0;
    z-index:-3;
}

.bgOverlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    z-index:-2;
}

/* HEADING BAR */
.headerBar {
    width:90%;
    margin:25px auto 20px auto;
    padding:15px;
    text-align:center;
    background:rgba(255,255,255,0.08);
    border-radius:12px;
    backdrop-filter:blur(14px);
    box-shadow:0 0 16px rgba(0,0,0,0.4);
}

h1 {
    margin:0;
    font-size:34px;
    font-weight:700;
    text-shadow:0 0 12px rgba(0,160,255,0.7);
}

/* CONTROL PANEL - 1 ROW 3 COLUMNS */
.control-row {
    width:95%;
    display:flex;
    gap:18px;
    margin:0 auto;
    justify-content:space-between;
    flex-wrap:wrap;
}

/* EACH GLASS COLUMN */
.control-col {
    flex:1;
    min-width:290px;
    padding:10px 14px;
    background:rgba(255,255,255,0.09);
    border-radius:12px;
    backdrop-filter:blur(14px);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    box-shadow:0 0 16px rgba(0,0,0,0.4);
}

/* Inputs + Buttons */
input, select, button {
    height:36px;
    padding:4px 10px;
    border-radius:6px;
    border:none;
    font-size:14px;
}

input, select {
    background:rgba(255,255,255,0.85);
    color:black;
}

button {
    background:#1e90ff;
    color:white;
    cursor:pointer;
}

button:hover { background:#5ab3ff; }

.danger { background:#ff4d4d !important; }
.danger:hover { background:#ff7979 !important; }

/* VIEW SCOREBAR */
.viewBar {
    width:90%;
    margin:25px auto 0 auto;
    padding:15px;
    background:rgba(255,255,255,0.09);
    border-radius:12px;
    backdrop-filter:blur(14px);
    text-align:center;
}

/* SCORE TABLE */
table {
    width:95%;
    margin:25px auto;
    border-collapse:collapse;
    background:rgba(255,255,255,0.07);
    backdrop-filter:blur(12px);
    border-radius:14px;
    overflow:hidden;
}

th, td {
    text-align:center;
    padding:12px;
}

th {
    background:rgba(0,60,120,0.7);
    font-size:17px;
}

td.name {
    text-align:left;
    padding-left:12px;
}

/* ðŸ”” SLIDE-IN ERROR POPUP */
#excelErrorPopup {
    position:fixed;
    left:50%;
    top:-300px;
    transform:translateX(-50%);
    width:90%;
    max-width:420px;
    background:rgba(0,0,0,0.92);
    padding:20px;
    border-radius:12px;
    color:white;
    text-align:center;
    z-index:200;
    animation-duration:0.7s;
    animation-fill-mode:forwards;
}

@keyframes slideDown {
    from { top:-300px; opacity:0; }
    to   { top:120px; opacity:1; }
}

/* EDIT NAME POPUP */
#editNamePopup {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:#111;
    padding:20px;
    width:90%; max-width:400px;
    border-radius:12px;
    text-align:center;
    display:none;
    z-index:300;
}

#editNamePopup input {
    width:80%;
    margin-top:10px;
    height:36px;
}

/* HELP POPUP */
#helpPopup {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    width:90%; max-width:520px;
    background:rgba(0,0,0,0.95);
    padding:20px;
    border-radius:12px;
    color:white;
    display:none;
    z-index:300;
}

#helpPopup h2 { margin-top:0; font-size:24px; }

</style>
</head>

<body>

<div class="bg"></div>
<div class="bgOverlay"></div>

<div class="headerBar">
    <h1>Ice Skating Short Track Ranking Dashboard</h1>
</div>

<!-- â­â­â­ CONTROL ROW â­â­â­ -->
<div class="control-row">

    <!-- COLUMN 1 -->
    <div class="control-col">
        <input type="file" id="excelFile" accept=".xls,.xlsx">
        <button onclick="uploadExcel()">Upload Excel</button>
    </div>

    <!-- COLUMN 2 -->
    <div class="control-col">
        <input id="skaterName" placeholder="Manually enter the name">
        <button onclick="addManual()">Add</button>
        <select id="addGroupSelect">
            <option>Alpha</option><option>Bravo</option><option>Charlie</option>
            <option>Delta</option><option>Echo</option><option>Foxtrot</option>
            <option>Golf</option><option>Hotel</option><option>India</option>
        </select>
    </div>

    <!-- COLUMN 3 -->
    <div class="control-col">
        <button class="danger" onclick="resetGroup()">Reset Group</button>
        <button class="danger" onclick="resetAll()">Reset All Groups</button>
        <button onclick="openHelp()">Help / Instructions</button>
    </div>

</div>

<!-- SELECT GROUP DISPLAY -->
<div class="viewBar">
    <label style="font-size:18px;font-weight:bold;">Select Group to View Scoreboard</label><br>
    <select id="viewGroupSelect" onchange="switchGroup()" style="width:220px;margin-top:8px;">
        <option>Alpha</option><option>Bravo</option><option>Charlie</option>
        <option>Delta</option><option>Echo</option><option>Foxtrot</option>
        <option>Golf</option><option>Hotel</option><option>India</option>
    </select>
</div>

<!-- SCOREBOARD TABLE -->
<table id="scoreTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>400</th><th>500</th><th>800</th><th>1000</th><th>1500</th>
            <th>Total</th><th>Rank</th><th>Undo</th><th>Delete</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- ðŸ”” ERROR POPUP -->
<div id="excelErrorPopup">
    <p style="font-size:16px; line-height:1.5;">
        <b><i>
        SORRY IF THE EXCEL FILE DOES NOT UPLOAD PROPERLY â€” SOMETIMES THERE MAY BE A SMALL GLITCH.<br><br>
        MY APOLOGIES. PLEASE TRY ENTERING THE NAMES MANUALLY.<br><br>
        ALL THE BEST!
        </i></b>
    </p>
    <button onclick="closeExcelErrorPopup()" 
            style="margin-top:12px; padding:10px 20px; background:#1e90ff; color:white; border:none; border-radius:6px; cursor:pointer;">
        CLOSE
    </button>
</div>

<!-- EDIT NAME POPUP -->
<div id="editNamePopup">
    <h2>Edit Name</h2>
    <input id="editNameInput">
    <br><br>
    <button onclick="saveEditedName()">Save</button>
    <button class="danger" onclick="closeEditName()">Cancel</button>
</div>

<!-- HELP POPUP -->
<!-- HELP POPUP -->
<div id="helpPopup" style="
    display:none; 
    position:fixed; 
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    width:90%; max-width:480px;
    background:rgba(0,0,0,0.92);
    padding:20px;
    border-radius:12px;
    color:white;
    text-align:left;
    line-height:1.6;
    z-index:300;">
    
    <h2 style="margin-top:0; text-align:center;">Instructions</h2>

    <p>â€¢ Upload Excel to auto-add skaters into correct groups.</p>
    <p>â€¢ Add names manually if the Excel file does not upload properly.</p>
    <p>â€¢ Select a group from the dropdown to view that groupâ€™s scoreboard.</p>
    <p>â€¢ Enter race positions for each distance to calculate points.</p>
    <p>â€¢ Rankings update automatically based on total points.</p>
    <p>â€¢ Gold, silver, and bronze medals appear for the top three scores.</p>
    <p>â€¢ Click a skaterâ€™s name to edit it and save changes.</p>
    <p>â€¢ Use Undo to reverse the last score entry for a skater.</p>
    <p>â€¢ Use Delete to remove a skater completely from the group.</p>
    <p>â€¢ Reset Group clears only the current group; Reset All clears everything.</p>
    <p>â€¢ All data saves automatically and stays even after refreshing.</p>

    <button onclick="closeHelp()" 
            style="margin-top:12px; width:100%; padding:10px; 
            background:#1e90ff; color:white; border:none; 
            border-radius:6px; cursor:pointer;">
        Close
    </button>
</div>


<script>

/* ------------------------------------------------------
      SLIDE-IN POPUP
-------------------------------------------------------*/
function showExcelErrorPopup() {
    const popup = document.getElementById("excelErrorPopup");
    popup.style.display = "block";
    popup.style.animationName = "slideDown";
}
function closeExcelErrorPopup() {
    document.getElementById("excelErrorPopup").style.display = "none";
}

/* ------------------------------------------------------
      EXCEL UPLOAD
-------------------------------------------------------*/
const validGroups = ["ALPHA","BRAVO","CHARLIE","DELTA","ECHO","FOXTROT","GOLF","HOTEL","INDIA"];

function isName(x) {
    if (!x || typeof x !== "string") return false;
    x = x.trim();
    if (x.length < 2) return false;
    if (/[^A-Za-zÃ€-Ã¿ '-]/.test(x)) return false;
    return true;
}

function uploadExcel() {
    let file = document.getElementById("excelFile").files[0];
    if (!file) return alert("Please select an Excel file.");

    let reader = new FileReader();

    reader.onload = function(e) {
        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, {type:'array'});

        let sheet = workbook.Sheets["Divisions"];
        if (!sheet) return showExcelErrorPopup();

        let rows = XLSX.utils.sheet_to_json(sheet, {header:1});
        let detectedGroup = null;
        let addedCount = 0;

        for (let r=0; r<rows.length; r++) {
            let row = rows[r];
            if (!row) continue;

            let cell = row[7];
            if (typeof cell === "string") {
                let G = cell.trim().toUpperCase();
                if (validGroups.includes(G)) {
                    detectedGroup = G.charAt(0)+G.slice(1).toLowerCase();
                    continue;
                }
            }

            let cells = [
                (row[1] || "").toString().trim(),
                (row[2] || "").toString().trim(),
                (row[3] || "").toString().trim(),
                (row[4] || "").toString().trim()
            ];

            let combined = (cells.join(" ").toUpperCase()).replace(/\s+/g, " ").trim();
            let headerBlacklist = [
                "FIRST","LAST","FULL","NAME",
                "FIRST NAME","LAST NAME","FULL NAME",
                "SKATER","ATHLETE","COMPETITOR","PARTICIPANT"
            ];

            if (headerBlacklist.some(h => combined.includes(h))) continue;

            let name = null;
            if (isName(cells[0]) && isName(cells[1])) name = cells[0] + " " + cells[1];
            else if (isName(cells[1]) && isName(cells[2])) name = cells[1] + " " + cells[2];
            else if (isName(cells[2]) && isName(cells[3])) name = cells[2] + " " + cells[3];

            if (name && detectedGroup) {
                name = cleanName(name);
                addSkaterToGroup(name, detectedGroup);
                addedCount++;
            }
        }

        if (addedCount === 0) showExcelErrorPopup();
        else { saveData(); loadGroupTable(); }
    };

    reader.readAsArrayBuffer(file);
}

/* ------------------------------------------------------
      MAIN DATA STRUCTURE
-------------------------------------------------------*/
let groups = {};
["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
.forEach(g => groups[g] = { skaters:[], history:{} });

if (localStorage.getItem("groupsData")) {
    groups = JSON.parse(localStorage.getItem("groupsData"));
}

let currentGroup = "Alpha";

const distances = ["400","500","800","1000","1500"];

const points = {1:1000,2:816,3:666,4:543,5:443,6:362,7:295,8:241,9:196,10:160,
                11:130,12:106,13:86,14:70,15:57};

function saveData(){ localStorage.setItem("groupsData", JSON.stringify(groups)); }

/* ------------------------------------------------------
      GROUP SWITCHING / RESET
-------------------------------------------------------*/
function switchGroup(){
    currentGroup = document.getElementById("viewGroupSelect").value;
    loadGroupTable();
}

function resetGroup(){
    if (!confirm("Reset this group?")) return;
    groups[currentGroup] = {skaters:[], history:{}};
    saveData();
    loadGroupTable();
}

function resetAll(){
    if (!confirm("Reset ALL groups?")) return;
    ["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India"]
    .forEach(g => groups[g] = {skaters:[], history:{}});
    saveData();
    loadGroupTable();
}

/* ------------------------------------------------------
      ADD / CLEAN NAMES
-------------------------------------------------------*/
function cleanName(n){
    if (!n) return "";
    return n.replace(/[0-9]/g,"").replace(/\s+/g," ").trim();
}

function addManual(){
    let name = cleanName(document.getElementById("skaterName").value.trim());
    if (!name) return;

    let g = document.getElementById("addGroupSelect").value;
    addSkaterToGroup(name, g);

    document.getElementById("skaterName").value = "";
}

function addSkaterToGroup(name, group){
    let G = groups[group];
    if (!G.skaters.includes(name)) {
        G.skaters.push(name);
        G.history[name] = {"400":[],"500":[],"800":[],"1000":[],"1500":[]};
    }
    saveData();
    if (group === currentGroup) loadGroupTable();
}

/* ------------------------------------------------------
      LOAD TABLE
-------------------------------------------------------*/
function loadGroupTable(){
    let tbody = document.querySelector("#scoreTable tbody");
    tbody.innerHTML = "";

    groups[currentGroup].skaters.forEach(name=>{

        let row = document.createElement("tr");
        row.dataset.name = name;

        row.innerHTML = `
            <td class="name" onclick="openEditName('${name}')">${name}</td>
            <td></td><td></td><td></td><td></td><td></td>
            <td class="total">0</td>
            <td class="rank">-</td>
            <td><button class="danger" onclick="undo('${name}')">Undo</button></td>
            <td><button class="danger" onclick="deleteSkater('${name}')">Delete</button></td>
        `;

        distances.forEach((dist,i)=>{
            let cell = row.children[i+1];
            cell.appendChild(createDropdown(name,dist));
        });

        tbody.appendChild(row);
    });

    rebuildDropdowns();
    updateScores();
}

/* ------------------------------------------------------
      DROPDOWNS
-------------------------------------------------------*/
function createDropdown(name, dist){
    let dd = document.createElement("select");
    dd.className = "position";
    dd.innerHTML = `<option value="">-</option>`;

    let count = groups[currentGroup].skaters.length;
    for (let i=1; i<=count; i++) dd.innerHTML+=`<option>${i}</option>`;

    dd.onchange = ()=>{
        groups[currentGroup].history[name][dist].push(dd.getAttribute("data-last")||"");
        dd.setAttribute("data-last", dd.value);
        updateScores();
        saveData();
    };

    return dd;
}

function rebuildDropdowns(){
    let count = groups[currentGroup].skaters.length;

    document.querySelectorAll("select.position").forEach(dd=>{
        let old = dd.value;
        dd.innerHTML = `<option value="">-</option>`;
        for (let i=1; i<=count; i++) dd.innerHTML+=`<option>${i}</option>`;
        dd.value = old;
    });
}

/* ------------------------------------------------------
      SCORES + RANKING + MEDALS
-------------------------------------------------------*/
function updateScores(){
    let rows = document.querySelectorAll("#scoreTable tbody tr");
    let anyScore = false;

    rows.forEach(row=>{
        let total = 0;

        row.querySelectorAll("select.position").forEach(dd=>{
            let pos = Number(dd.value);
            if (points[pos]) total += points[pos];
        });

        row.querySelector(".total").textContent = total;
        if (total > 0) anyScore = true;
    });

    if (!anyScore){
        rows.forEach(row=>{
            row.querySelector(".name").innerHTML =
                row.dataset.name;
            row.querySelector(".rank").textContent = "-";
        });
        return;
    }

    let sorted = [...rows].sort((a,b)=>
        b.querySelector(".total").textContent - a.querySelector(".total").textContent
    );

    sorted.forEach((row,i)=>{
        let rank = i+1;
        let baseName = row.dataset.name;  
        let cell = row.querySelector(".name");

        if (rank === 1) cell.innerHTML = "ðŸ¥‡ " + baseName;
        else if (rank === 2) cell.innerHTML = "ðŸ¥ˆ " + baseName;
        else if (rank === 3) cell.innerHTML = "ðŸ¥‰ " + baseName;
        else cell.innerHTML = baseName;

        row.querySelector(".rank").textContent = rank;
    });
}

/* ------------------------------------------------------
      UNDO + DELETE
-------------------------------------------------------*/
function undo(name){
    let g = groups[currentGroup];
    let row = document.querySelector(`tr[data-name="${name}"]`);

    row.querySelectorAll("select.position").forEach((dd,i)=>{
        let dist = distances[i];
        let stack = g.history[name][dist];

        if (stack.length > 0){
            let prev = stack.pop();
            dd.value = prev || "";
            dd.setAttribute("data-last", prev || "");
        }
    });

    updateScores();
    saveData();
}

function deleteSkater(name){
    let g = groups[currentGroup];
    g.skaters = g.skaters.filter(n=>n!==name);
    delete g.history[name];

    saveData();
    loadGroupTable();
}

/* ------------------------------------------------------
      NAME EDIT POPUP
-------------------------------------------------------*/
let nameBeingEdited = null;

function openEditName(name){
    nameBeingEdited = name;
    document.getElementById("editNameInput").value = name;
    document.getElementById("editNamePopup").style.display = "block";
}

function closeEditName(){
    nameBeingEdited = null;
    document.getElementById("editNamePopup").style.display = "none";
}

function saveEditedName(){
    let newName = cleanName(document.getElementById("editNameInput").value.trim());
    if (!newName) return;

    let group = groups[currentGroup];

    let index = group.skaters.indexOf(nameBeingEdited);
    if (index !== -1) group.skaters[index] = newName;

    group.history[newName] = group.history[nameBeingEdited];
    delete group.history[nameBeingEdited];

    saveData();
    closeEditName();
    loadGroupTable();
}

/* HELP POPUP */
function openHelp(){document.getElementById("helpPopup").style.display="block";}
function closeHelp(){document.getElementById("helpPopup").style.display="none";}

loadGroupTable();

</script>

</body>
</html>
