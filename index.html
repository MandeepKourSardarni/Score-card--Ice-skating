<!DOCTYPE html>
<html>
<head>
<title>Ice Skating Short Track Ranking Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* --------------------------------------------------
    GLOBAL + BACKGROUND
--------------------------------------------------*/
body {
    margin:0;
    padding:0;
    font-family:'Segoe UI',Arial,sans-serif;
    background:transparent !important;
    color:white;
}

.bg {
    background-image:url("https://raw.githubusercontent.com/MandeepKourSardarni/Ice-Skating-short-track-Ranking-Dashboard/main/image.jpg?raw=1");
    background-size:cover;
    background-position:center;
    background-attachment:fixed;
    position:fixed;
    inset:0;
    z-index:-3;
}

.bgOverlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    z-index:-2;
}

/* --------------------------------------------------
      SLIDING THEME TOGGLE
--------------------------------------------------*/
.theme-toggle-wrapper {
    display:flex;
    align-items:center;
    justify-content:center;
}

.theme-switch {
    --h: 24px;
    --w: 48px;
    width:var(--w);
    height:var(--h);
    border-radius:var(--h);
    background:#ddd;
    position:relative;
    cursor:pointer;
    transition:0.3s;
    border:none;
}

.theme-switch .slider {
    width:calc(var(--h) - 6px);
    height:calc(var(--h) - 6px);
    background:white;
    border-radius:50%;
    position:absolute;
    top:3px;
    left:3px;
    transition:0.3s ease;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
}

.theme-switch.dark {
    background:#222;
}
.theme-switch.dark .slider {
    transform:translateX(24px);
}

.sun { display:none; }
.moon { display:block; }
.dark .sun { display:block; }
.dark .moon { display:none; }

/* --------------------------------------------------
    THEME OVERRIDES
--------------------------------------------------*/
.light-mode body { color:black !important; }

.light-mode .headerBar,
.light-mode .control-col,
.light-mode .viewBar,
.light-mode table {
    background:rgba(255, 255, 255, 0.315) !important;
    color:black !important;
}

.light-mode th {
    background:rgba(0,80,160,0.8) !important;
}

.dark-mode body { color:white !important; }

.dark-mode .headerBar,
.dark-mode .control-col,
.dark-mode .viewBar,
.dark-mode table {
    background:rgba(40,40,40,0.55) !important;
    color:white !important;
}

.dark-mode th {
    background:rgba(0,60,120,0.8) !important;
}

/* --------------------------------------------------
           HEADER BAR
--------------------------------------------------*/
.headerBar {
    width:90%;
    margin:25px auto 20px auto;
    padding:15px;
    text-align:center;
    background:rgba(255,255,255,0.08);
    border-radius:12px;
    backdrop-filter:blur(14px);
    box-shadow:0 0 16px rgba(0,0,0,0.4);
}

h1 {
    margin:0;
    font-size:34px;
    font-weight:700;
    text-shadow:0 0 12px rgba(0,160,255,0.7);
}

/* --------------------------------------------------
          CONTROL PANEL
--------------------------------------------------*/
.control-row {
    width:95%;
    display:flex;
    gap:18px;
    margin:0 auto;
    justify-content:space-between;
    flex-wrap:wrap;
}

.control-col {
    flex:1;
    min-width:260px;
    padding:10px 14px;
    background:rgba(255,255,255,0.09);
    border-radius:12px;
    backdrop-filter:blur(14px);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    box-shadow:0 0 16px rgba(0,0,0,0.4);
}

/* --------------------------------------------------
      INPUTS + BUTTONS
--------------------------------------------------*/
input, select, button {
    height:36px;
    padding:4px 10px;
    border-radius:6px;
    border:none;
    font-size:14px;
}

input, select {
    background:rgba(255,255,255,0.85);
    color:black;
}

button {
    background:#1e90ff;
    color:white;
    cursor:pointer;
}

button:hover { background:#5ab3ff; }

.danger { background:#ff4d4d !important; }
.danger:hover { background:#ff7979 !important; }

/* Make Actions button above glass */
#addDistanceBtn {
    position:relative;
    z-index:2000;
}

/* --------------------------------------------------
   SCOREBOARD TABLE
--------------------------------------------------*/
.viewBar {
    width:90%;
    margin:25px auto 0 auto;
    padding:15px;
    background:rgba(255,255,255,0.09);
    border-radius:12px;
    text-align:center;
    backdrop-filter:blur(14px);
}

table {
    width:95%;
    margin:25px auto;
    border-collapse:collapse;
    background:rgba(255,255,255,0.07);
    backdrop-filter:blur(12px);
    border-radius:14px;
    overflow:hidden;
}

th, td {
    text-align:center;
    padding:12px;
}

th {
    background:rgba(0,60,120,0.7);
    font-size:17px;
}

td.name { text-align:left; padding-left:12px; }

/* --------------------------------------------------
        POPUPS
--------------------------------------------------*/
#excelErrorPopup {
    position:fixed;
    left:50%;
    top:140px;
    transform:translateX(-50%);
    width:90%;
    max-width:420px;
    background:rgba(0,0,0,0.85);
    padding:20px;
    border-radius:12px;
    color:white;
    text-align:center;
    z-index:99999;
    display:none;
}

#excelErrorPopup .excelMsg {
    font-family: Arial, sans-serif;
    font-style: italic;
    font-size:16px;
    margin-bottom:12px;
}

#excelErrorPopup button {
    background:#1e90ff;
    border:none;
    padding:10px 20px;
    border-radius:6px;
    color:white;
    cursor:pointer;
}
#excelErrorPopup button:hover { background:#5ab3ff; }

/* Glass Confirm Popup */
.glassConfirm {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.45);
    backdrop-filter:blur(6px);
    z-index:500;
    align-items:center;
    justify-content:center;
}

.confirmBox {
    width:90%;
    max-width:360px;
    padding:20px;
    background:rgba(255,255,255,0.10);
    border-radius:14px;
    backdrop-filter:blur(18px);
    color:white;
    text-align:center;
}

.confirmButtons {
    margin-top:18px;
    display:flex;
    justify-content:space-between;
}

.confirmCancel,
.confirmYes {
    flex:1;
    margin:0 6px;
    padding:10px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:15px;
}

.confirmCancel { background:#555; }
.confirmYes { background:#1e90ff; }

.confirmCancel:hover { background:#777; }
.confirmYes:hover { background:#5ab3ff; }

/* Edit & Help popups */
#editNamePopup,
#helpPopup {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:#010114;
    padding:20px;
    width:90%; max-width:400px;
    border-radius:12px;
    color:white;
    text-align:center;
    display:none;
    z-index:300;
}

/* ADD / MANAGE DISTANCE + ACTIONS POPUPS */
#distancePopup,
#manageDistancesPopup,
#actionsPopup {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    backdrop-filter:blur(6px);
    color:white;
    z-index:5000;
    align-items:center;
    justify-content:center;
}

.distanceBox {
    width:90%;
    max-width:380px;
    padding:20px;
    background:rgba(255,255,255,0.1);
    border-radius:14px;
    text-align:center;
}

.distanceBox input {
    width:80%;
    margin-top:10px;
    font-size:16px;
}

/* Manage distances rows */
.distanceRow {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    margin:6px 0;
}

.distanceRow input {
    width:80px;
    text-align:center;
}

/* ==================================================
   üéÅ GIFT (PAYPAL) BUTTON + POPUP
=================================================== */
.giftBtn{
    background:rgba(255,255,255,0.15);
    border:1px solid rgba(255,255,255,0.22);
    backdrop-filter:blur(10px);
    height:36px;
    width:36px;
    border-radius:10px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    line-height:1;
}
.giftBtn:hover{ background:rgba(255,255,255,0.25); }

#paypalPopup{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    backdrop-filter:blur(6px);
    z-index:6000;
    align-items:center;
    justify-content:center;
}
.paypalBox{
    width:90%;
    max-width:380px;
    padding:20px;
    background:rgba(255,255,255,0.12);
    border-radius:14px;
    text-align:center;
    color:white;
}
.paypalLinks{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:12px;
}
.paypalLinks a{
    text-decoration:none;
}
.paypalLinks button{
    height:36px;
}
</style>
</head>

<body>

<div class="bg"></div>
<div class="bgOverlay"></div>

<div class="headerBar">
    <h1>Ice Skating Short Track Ranking Dashboard</h1>
</div>

<!-- CONTROL ROW -->
<div class="control-row">

    <div class="control-col">
        <input type="file" id="excelFile" accept=".xls,.xlsx">
        <button onclick="uploadExcel()">Upload Excel</button>
    </div>

    <div class="control-col">
        <input id="skaterName" placeholder="Manually enter the name">
        <button onclick="addManual()">Add</button>
        <select id="addGroupSelect">
            <option>Alpha</option><option>Bravo</option><option>Charlie</option>
            <option>Delta</option><option>Echo</option><option>Foxtrot</option>
            <option>Golf</option><option>Hotel</option><option>India</option>
        </select>
    </div>

    <div class="control-col">
        <button class="danger" onclick="resetGroup()">Reset Group</button>
        <button class="danger" onclick="resetAll()">Reset All Groups</button>
        <button onclick="openHelp()">Help</button>
        <button id="addDistanceBtn" onclick="openActionsPopup()">Actions</button>

        <div class="theme-toggle-wrapper" style="gap:10px;">
            <button id="themeToggle" class="theme-switch">
                <div class="slider">
                    <span class="moon">üåô</span>
                    <span class="sun">‚òÄÔ∏è</span>
                </div>
            </button>

            <!-- üéÅ PayPal button -->
            <button class="giftBtn" onclick="openPaypalPopup()" title="Support via PayPal">üéÅ</button>
        </div>
    </div>

</div>

<!-- VIEW BAR -->
<div class="viewBar">
    <div id="excelHeading"
         style="display:none; font-size:18px; margin-bottom:12px; white-space:normal;">
    </div>

    <label>Select Group</label><br>
    <select id="viewGroupSelect" onchange="switchGroup()" style="width:220px;margin-top:8px;">
        <option>Alpha</option><option>Bravo</option><option>Charlie</option>
        <option>Delta</option><option>Echo</option><option>Foxtrot</option>
        <option>Golf</option><option>Hotel</option><option>India</option>
    </select>
</div>

<!-- SCOREBOARD TABLE -->
<table id="scoreTable">
    <thead>
        <tr id="headerRow"></tr>
    </thead>
    <tbody></tbody>
</table>

<!-- CUTE GLASS ERROR POPUP -->
<div id="excelErrorPopup">
    <div class="excelErrorBox">
        <h3>‚ö†Ô∏è Oops!</h3>

        <p>
            The Excel file looks a little <b>glitchy</b> or not in the expected format
        </p>

        <p style="margin-top:8px;">
            You can try uploading again<br>
            or enter the names manually ‚Äî both work!
        </p>

        <button onclick="closeExcelErrorPopup()">Got it üòä</button>
    </div>
</div>

<div id="editNamePopup">
    <h2>Edit Name</h2>
    <input id="editNameInput">
    <br><br>
    <button onclick="saveEditedName()">Save</button>
    <button class="danger" onclick="closeEditName()">Cancel</button>
</div>

<div id="helpPopup">
    <h2>Instructions</h2>

    <p>üìÑ Start by uploading the official Excel file with clubs and divisions</p>
    <p>‚úèÔ∏è You can also type skater names, and select group manually if that‚Äôs easier</p>

    <p>üèÖ Choose each skater‚Äôs race position in the race</p>
    <p>‚ú® The dashboard automatically calculates scores & updates rank instantly</p>

    <p>‚öôÔ∏è Use the ‚ÄúActions‚Äù button to add, edit or delete race distances (points stay the same)</p>

    <p>üìå You can switch between different groups anytime ‚Äî each group keeps its own list</p>
    <p>üìå All entries are safely stored on YOUR DEVICE so you can return anytime</p>

    <p>‚Ü©Ô∏è Made a mistake? You can undo or edit any name or position</p>
    <p>üóëÔ∏è To start fresh with the group, reset the current group ‚Äî or use ‚ÄúRESET ALL GROUPS‚Äù for a complete clean slate</p>

    <p>Hope this makes tracking your skaters simple and fun!</p>
    <p>üíô All the Best üíô</p>

    <button onclick="closeHelp()">Close</button>
</div>

<!-- Confirm Popup -->
<div id="confirmPopup" class="glassConfirm">
    <div class="confirmBox">
        <p id="confirmMessage">Are you sure?</p>
        <div class="confirmButtons">
            <button class="confirmCancel" onclick="closeConfirm(false)">Cancel</button>
            <button class="confirmYes" onclick="closeConfirm(true)">Yes</button>
        </div>
    </div>
</div>

<!-- Actions Popup -->
<div id="actionsPopup">
    <div class="distanceBox">
        <h2>Actions</h2>
        <button onclick="openDistanceFromActions()">‚ûï Add New Distance</button>
        <br><br>
        <button onclick="openManageFromActions()">‚úèÔ∏è Edit / Delete Distances</button>
        <br><br>
        <button class="danger" onclick="closeActionsPopup()">Close</button>
    </div>
</div>

<!-- ADD DISTANCE POPUP -->
<div id="distancePopup">
    <div class="distanceBox">
        <h2>Add New Distance</h2>
        <p>Enter numeric distance (e.g., 300)</p>
        <input id="newDistanceInput"
               placeholder="300"
               oninput="this.value=this.value.replace(/[^0-9]/g,'');">
        <br><br>
        <button onclick="saveNewDistance()">Add</button>
        <button class="danger" onclick="closeDistancePopup()">Cancel</button>
    </div>
</div>

<!-- MANAGE DISTANCES POPUP -->
<div id="manageDistancesPopup">
    <div class="distanceBox">
        <h2>Edit / Delete Distances</h2>
        <p>You can change values (e.g., 300, 600) or delete rows.</p>
        <div id="distancesList"></div>
        <br>
        <button onclick="saveManagedDistances()">Save</button>
        <button class="danger" onclick="closeManageDistances()">Close</button>
    </div>
</div>

<!-- ‚úÖ PAYPAL POPUP -->
<div id="paypalPopup">
  <div class="paypalBox">
    <h2 style="margin:0 0 8px 0;">Support this dashboard üíô</h2>
    <p style="margin:0; opacity:0.95;">If this helps you, you can donate via PayPal</p>

    <div class="paypalLinks">
      <!-- Replace MandeepKour with your PayPal.me username -->
      <a href="https://www.paypal.me/MandeepSardarni/2" target="_blank"><button>$2</button></a>
      <a href="https://www.paypal.me/MandeepSardarni/5" target="_blank"><button>$5</button></a>
      <a href="https://www.paypal.me/MandeepSardarni/10" target="_blank"><button>$10</button></a>
      <a href="https://www.paypal.me/MandeepSardarni" target="_blank"><button>Custom</button></a>
    </div>

    <br>
    <button class="danger" onclick="closePaypalPopup()">Close</button>
  </div>
</div>

<script>
/* ==================================================
      THEME TOGGLE
=================================================== */
const toggleBtn = document.getElementById("themeToggle");
let savedTheme = localStorage.getItem("theme") || "dark";

applyTheme(savedTheme);

toggleBtn.onclick = () => {
    let newTheme =
      document.body.classList.contains("dark-mode") ? "light" : "dark";
    applyTheme(newTheme);
};

function applyTheme(mode) {
    if (mode === "light") {
        document.body.classList.remove("dark-mode");
        document.body.classList.add("light-mode");
        toggleBtn.classList.remove("dark");
    } else {
        document.body.classList.remove("light-mode");
        document.body.classList.add("dark-mode");
        toggleBtn.classList.add("dark");
    }
    localStorage.setItem("theme", mode);
}

/* ==================================================
      ERROR POPUP
=================================================== */
function showExcelErrorPopup() {
    document.getElementById("excelErrorPopup").style.display = "block";
}
function closeExcelErrorPopup() {
    document.getElementById("excelErrorPopup").style.display = "none";
}

/* ==================================================
      CONFIRM POPUP
=================================================== */
let confirmCallback = null;

function showConfirm(message, callback) {
    document.getElementById("confirmMessage").textContent = message;
    document.getElementById("confirmPopup").style.display = "flex";
    confirmCallback = callback;
}

function closeConfirm(result) {
    document.getElementById("confirmPopup").style.display = "none";
    if (confirmCallback) confirmCallback(result);
}

/* ==================================================
      EXCEL HELPERS
=================================================== */
const validGroups = [
    "ALPHA","BRAVO","CHARLIE","DELTA","ECHO",
    "FOXTROT","GOLF","HOTEL","INDIA"
];

function isName(x){
    if(!x || typeof x!=="string")return false;
    x=x.trim();
    if(x.length<2)return false;
    if(/[^A-Za-z√Ä-√ø '-]/.test(x))return false;
    return true;
}

/* ==================================================
      DATA STRUCTURE
=================================================== */
let groups = {};
["Alpha","Bravo","Charlie","Delta","Echo",
 "Foxtrot","Golf","Hotel","India"]
.forEach(g=>groups[g]={skaters:[],history:{}});

if(localStorage.getItem("groupsData")){
    try {
        groups = JSON.parse(localStorage.getItem("groupsData"));
    } catch(e) {
        console.error("Bad local groupsData, resetting", e);
        ["Alpha","Bravo","Charlie","Delta","Echo",
         "Foxtrot","Golf","Hotel","India"]
         .forEach(g=>groups[g]={skaters:[],history:{}});        
    }
}

let currentGroup = "Alpha";

/* ---- Dynamic distances ---- */
const defaultDistances = ["400","500","800","1000","1200","1500"];
let distances = JSON.parse(localStorage.getItem("distances") || "null") || [...defaultDistances];

function saveDistances(){
    localStorage.setItem("distances", JSON.stringify(distances));
}

/* Points remain same */
const points = {
    1:1000,2:816,3:666,4:543,5:443,
    6:362,7:295,8:241,9:196,10:160,
    11:130,12:106,13:86,14:70,15:57
};

function saveData(){
    localStorage.setItem("groupsData",JSON.stringify(groups));
}

/* ==================================================
      EXCEL UPLOAD (with heading)
=================================================== */
function uploadExcel(){
    let file=document.getElementById("excelFile").files[0];
    if(!file)return alert("Please select an Excel file.");

    let reader=new FileReader();

    reader.onload=function(e){
        let data=new Uint8Array(e.target.result);
        let workbook=XLSX.read(data,{type:'array'});

        /* Heading from Club/Clubs/Divisions A1 if present */
        let sheetNames=["Club","Clubs","Divisions"];
        let headingText="";

        for (let s of sheetNames){
            let sheet=workbook.Sheets[s];
            if(!sheet) continue;
            let a1 = sheet["A1"] ? String(sheet["A1"].v).trim() : "";
            if(a1.length > 10){
                headingText=a1;
                break;
            }
        }
        if(headingText){
            let h=document.getElementById("excelHeading");
            h.textContent=headingText;
            h.style.display="block";
        }

        /* --- ORIGINAL name & group extraction from Divisions --- */
        let sheet=workbook.Sheets["Divisions"];
        if(!sheet)return showExcelErrorPopup();

        let rows=XLSX.utils.sheet_to_json(sheet,{header:1});
        let detectedGroup=null;
        let addedCount=0;

        for(let r=0;r<rows.length;r++){
            let row=rows[r];
            if(!row)continue;

            let cell=row[7];
            if(typeof cell==="string"){
                let G=cell.trim().toUpperCase();
                if(validGroups.includes(G)){
                    detectedGroup=G.charAt(0)+G.slice(1).toLowerCase();
                    continue;
                }
            }

            let cells=[
                (row[1]||"").toString().trim(),
                (row[2]||"").toString().trim(),
                (row[3]||"").toString().trim(),
                (row[4]||"").toString().trim()
            ];

            let combined=(cells.join(" ").toUpperCase()).replace(/\s+/g," ").trim();
            let headerBlacklist=[
                "FIRST","LAST","FULL","NAME",
                "SKATER","ATHLETE","COMPETITOR","PARTICIPANT"
            ];
            if(headerBlacklist.some(h=>combined.includes(h))) continue;

            let name=null;
            if(isName(cells[0]) && isName(cells[1])) name=cells[0]+" "+cells[1];
            else if(isName(cells[1]) && isName(cells[2])) name=cells[1]+" "+cells[2];
            else if(isName(cells[2]) && isName(cells[3])) name=cells[2]+" "+cells[3];

            if(name && detectedGroup){
                name=name.replace(/[0-9]/g,"").replace(/\s+/g," ").trim();
                addSkaterToGroup(name,detectedGroup);
                addedCount++;
            }
        }

        if(addedCount===0) showExcelErrorPopup();
        else { saveData(); loadGroupTable(); }
    };

    reader.readAsArrayBuffer(file);
}

/* ==================================================
      RESET (with distances reset on Reset All)
=================================================== */
function resetGroup(){
    showConfirm("Reset this group?", function(yes){
        if(!yes)return;
        groups[currentGroup]={skaters:[],history:{}};
        saveData();
        loadGroupTable();
    });
}

function resetAll(){
    showConfirm("Reset all groups and distances?", function(yes){
        if(!yes)return;
        ["Alpha","Bravo","Charlie","Delta","Echo",
         "Foxtrot","Golf","Hotel","India"]
         .forEach(g=>groups[g]={skaters:[],history:{}});

        saveData();

        // Reset distances back to default
        distances=[...defaultDistances];
        saveDistances();

        loadGroupTable();
    });
}

/* ==================================================
      ADD SKATER
=================================================== */
function addManual(){
    let name=document.getElementById("skaterName").value.trim();
    if(!name)return;

    let g=document.getElementById("addGroupSelect").value;
    addSkaterToGroup(name,g);

    document.getElementById("skaterName").value="";
}

function addSkaterToGroup(name,group){
    let G=groups[group];
    if(!G.skaters.includes(name)){
        G.skaters.push(name);

        // create history object; distHistory keys match current distances
        let distHistoryObj = {};
        distances.forEach(d=>distHistoryObj[d]=[]);
        G.history[name]={
            distHistory: distHistoryObj,
            stack:[]
        };
    }
    saveData();
    if(group===currentGroup) loadGroupTable();
}

/* ==================================================
      VIEW GROUP
=================================================== */
function switchGroup(){
    currentGroup=document.getElementById("viewGroupSelect").value;
    loadGroupTable();
}

/* ==================================================
      HEADER ROW (dynamic)
=================================================== */
function buildHeaderRow(){
    let row = document.getElementById("headerRow");
    row.innerHTML = "<th>Name</th>";
    distances.forEach(d=>{
        row.innerHTML += "<th>"+d+"</th>";
    });
    row.innerHTML += "<th>Total</th><th>Rank</th><th>Undo / Delete</th>";
}

/* ==================================================
      TABLE BUILD (dynamic distances)
=================================================== */
function loadGroupTable() {
    buildHeaderRow();

    let tbody = document.querySelector("#scoreTable tbody");
    tbody.innerHTML = "";

    let groupData = groups[currentGroup];

    groupData.skaters.forEach(name => {
        let row = document.createElement("tr");
        row.dataset.name = name;

        let html = `<td class="name" onclick="openEditName('${name}')">${name}</td>`;
        distances.forEach(()=>{ html += "<td></td>"; });

        html += `
            <td class="total">0</td>
            <td class="rank">-</td>
            <td>
                <button class="danger" onclick="undo('${name}')">Undo</button>
                <button class="danger" onclick="deleteSkater('${name}')">Delete</button>
            </td>
        `;

        row.innerHTML = html;

        distances.forEach((dist, i) => {
            let cell = row.children[i + 1];
            let dd = createDropdown(name, dist);
            cell.appendChild(dd);
        });

        tbody.appendChild(row);
    });

    rebuildDropdowns();

    // Restore positions from history
    groupData.skaters.forEach(name => {
        let row = document.querySelector(`tr[data-name="${name}"]`);
        let history = groups[currentGroup].history[name];
        if(!history) return;

        distances.forEach(dist => {
            let dd = row.querySelector(`select[data-dist="${dist}"]`);
            if(!dd) return;

            let stack = history.stack || [];
            let lastEntry = [...stack].reverse().find(s => s.dist === dist);

            if (lastEntry && lastEntry.current !== "") {
                dd.value = lastEntry.current;
                dd.setAttribute("data-last", lastEntry.current);
            } else {
                dd.value = "";
                dd.setAttribute("data-last", "");
            }
        });
    });

    updateScores();
}

/* ==================================================
      DROPDOWNS
=================================================== */
function createDropdown(name,dist){
    let dd=document.createElement("select");
    dd.className="position";
    dd.setAttribute("data-dist", dist);

    dd.innerHTML=`<option value="">-</option>`;
    let count=groups[currentGroup].skaters.length;

    for(let i=1;i<=count;i++) dd.innerHTML+=`<option>${i}</option>`;
    
    dd.onchange = () => {
        let prevVal = dd.getAttribute("data-last") || "";
        let newVal = dd.value;

        if(!groups[currentGroup].history[name]){
            groups[currentGroup].history[name] = {distHistory:{},stack:[]};
        }

        groups[currentGroup].history[name].stack.push({
            dist: dist,
            prev: prevVal,
            current: newVal
        });

        dd.setAttribute("data-last", newVal);

        updateScores();
        saveData();
    };

    return dd;
}

function rebuildDropdowns(){
    let count=groups[currentGroup].skaters.length;

    document.querySelectorAll("select.position").forEach(dd=>{
        let old=dd.value;
        dd.innerHTML=`<option value="">-</option>`;
        for(let i=1;i<=count;i++) dd.innerHTML+=`<option>${i}</option>`;
        dd.value=old;
    });
}

/* ==================================================
      SCORE + SORT + MEDALS
=================================================== */
function updateScores(){
    let tbody=document.querySelector("#scoreTable tbody");
    let rows=[...tbody.querySelectorAll("tr")];

    rows.forEach(row=>{
        let total=0;
        row.querySelectorAll("select.position").forEach(dd=>{
            let pos=Number(dd.value);
            if(points[pos]) total+=points[pos];
        });
        row.querySelector(".total").textContent=total;
    });

    let scored=rows.filter(r=>Number(r.querySelector(".total").textContent)>0);
    let unscored=rows.filter(r=>Number(r.querySelector(".total").textContent)===0);

    scored.sort((a,b)=>
        Number(b.querySelector(".total").textContent) -
        Number(a.querySelector(".total").textContent)
    );

    tbody.innerHTML="";
    scored.forEach(r=>tbody.appendChild(r));
    unscored.forEach(r=>tbody.appendChild(r));

    scored.forEach((row,index)=>{
        let rank=index+1;
        let nm=row.dataset.name;

        if(rank===1) row.querySelector(".name").innerHTML="ü•á "+nm;
        else if(rank===2) row.querySelector(".name").innerHTML="ü•à "+nm;
        else if(rank===3) row.querySelector(".name").innerHTML="ü•â "+nm;
        else row.querySelector(".name").innerHTML=nm;

        row.querySelector(".rank").textContent=rank;
    });

    unscored.forEach(r=>{
        r.querySelector(".name").innerHTML=r.dataset.name;
        r.querySelector(".rank").textContent="-";
    });
}

/* ==================================================
      UNDO
=================================================== */
function undo(name){
    let h=groups[currentGroup].history[name];
    if(!h || h.stack.length===0)return;

    let last=h.stack.pop();
    let dist=last.dist;
    let prev=last.prev;

    let row=document.querySelector(`tr[data-name="${name}"]`);
    let dd=row.querySelector(`select[data-dist="${dist}"]`);

    dd.value=prev;
    dd.setAttribute("data-last",prev);

    updateScores();
    saveData();
}

/* ==================================================
      DELETE SKATER
=================================================== */
function deleteSkater(name){
    groups[currentGroup].skaters =
      groups[currentGroup].skaters.filter(n=>n!==name);

    if(groups[currentGroup].history[name]){
        delete groups[currentGroup].history[name];
    }

    saveData();
    loadGroupTable();
}

/* ==================================================
      EDIT NAME
=================================================== */
let nameBeingEdited=null;

function openEditName(name){
    nameBeingEdited=name;
    document.getElementById("editNameInput").value=name;
    document.getElementById("editNamePopup").style.display="block";
}

function closeEditName(){
    document.getElementById("editNamePopup").style.display="none";
    nameBeingEdited=null;
}

function saveEditedName(){
    let newName=document.getElementById("editNameInput").value.trim();
    if(!newName)return;

    let g=groups[currentGroup];
    let idx=g.skaters.indexOf(nameBeingEdited);
    if(idx!==-1) g.skaters[idx]=newName;

    g.history[newName]=g.history[nameBeingEdited];
    delete g.history[nameBeingEdited];

    saveData();
    closeEditName();
    loadGroupTable();
}

/* ==================================================
      HELP
=================================================== */
function openHelp(){
    document.getElementById("helpPopup").style.display="block";
}
function closeHelp(){
    document.getElementById("helpPopup").style.display="none";
}

/* ==================================================
      ACTIONS + DISTANCE POPUPS
=================================================== */
function openActionsPopup(){
    document.getElementById("actionsPopup").style.display="flex";
}
function closeActionsPopup(){
    document.getElementById("actionsPopup").style.display="none";
}

function openDistancePopup(){
    document.getElementById("distancePopup").style.display="flex";
}
function closeDistancePopup(){
    document.getElementById("distancePopup").style.display="none";
}

function openDistanceFromActions(){
    closeActionsPopup();
    openDistancePopup();
}

function openManageFromActions(){
    closeActionsPopup();
    openManageDistances();
}

function saveNewDistance(){
    let d = document.getElementById("newDistanceInput").value.trim();
    if(!d){
        alert("Enter a distance (numbers only)");
        return;
    }
    if(distances.includes(d)){
        alert("Distance already exists.");
        return;
    }

    distances.push(d);   // append at the end
    saveDistances();

    // ensure distHistory keys exist
    Object.keys(groups).forEach(gName=>{
        let g = groups[gName];
        Object.keys(g.history).forEach(skater=>{
            if(g.history[skater].distHistory && !g.history[skater].distHistory[d]){
                g.history[skater].distHistory[d]=[];
            }
        });
    });

    document.getElementById("newDistanceInput").value = "";
    closeDistancePopup();

    loadGroupTable();
    alert("Distance "+d+" added!");
}

/* ==================================================
      MANAGE DISTANCES (EDIT / DELETE)
=================================================== */
function openManageDistances(){
    const popup = document.getElementById("manageDistancesPopup");
    const list = document.getElementById("distancesList");
    list.innerHTML = "";

    distances.forEach((d, idx) => {
        const row = document.createElement("div");
        row.className = "distanceRow";
        row.innerHTML = `
            <input type="text"
                   value="${d}"
                   data-index="${idx}"
                   oninput="this.value=this.value.replace(/[^0-9]/g,'');">
            <button class="danger" onclick="deleteDistance(${idx})">Delete</button>
        `;
        list.appendChild(row);
    });

    popup.style.display = "flex";
}

function closeManageDistances(){
    document.getElementById("manageDistancesPopup").style.display="none";
}

function deleteDistance(idx){
    distances.splice(idx,1);
    if(distances.length === 0){
        distances = [...defaultDistances];
    }
    saveDistances();
    openManageDistances();
}

function saveManagedDistances(){
    const inputs = document.querySelectorAll("#distancesList input");
    let newDists = [];

    inputs.forEach(inp => {
        let v = inp.value.trim();
        if(v) newDists.push(v);
    });

    if(newDists.length === 0){
        alert("At least one distance is required. Restoring defaults.");
        newDists = [...defaultDistances];
    }

    distances = newDists;
    saveDistances();

    Object.keys(groups).forEach(gName=>{
        let g = groups[gName];
        Object.keys(g.history).forEach(skater=>{
            let h = g.history[skater];
            if(!h.distHistory) h.distHistory = {};
            distances.forEach(d=>{
                if(!h.distHistory[d]) h.distHistory[d] = [];
            });
        });
    });

    closeManageDistances();
    loadGroupTable();
}

/* ==================================================
      üéÅ PAYPAL POPUP
=================================================== */
function openPaypalPopup(){
    document.getElementById("paypalPopup").style.display = "flex";
}
function closePaypalPopup(){
    document.getElementById("paypalPopup").style.display = "none";
}

/* ==================================================
      INITIAL LOAD
=================================================== */
loadGroupTable();
</script>

</body>
</html>
