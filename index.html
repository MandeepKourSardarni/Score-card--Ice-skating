<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ice Skating Short Track Ranking Dashboard</title>

  <!-- SheetJS for Excel import -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg1:#07162f;
      --bg2:#041022;

      /* ‚úÖ glass panes: 20% less opaque */
      --glass: rgba(255,255,255,.022);
      --glass2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.18);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --primary:#2f6bff;
      --danger:#ff4d4d;

      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius: 18px;

      --pad: clamp(14px, 2vw, 22px);
      --gap: clamp(12px, 1.6vw, 18px);

      --maxw: 1050px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Calibri, Helvetica, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(47,107,255,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(43,183,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Background image same as main code */
    .bg{
      position:fixed;
      inset:0;
      z-index:-2;
      background-image:url("https://raw.githubusercontent.com/MandeepKourSardarni/Ice-Skating-short-track-Ranking-Dashboard/main/image.jpg?raw=1");
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      opacity:.32;
      filter:saturate(1.05) contrast(1.05);
    }
    .bgOverlay{
      position:fixed;
      inset:0;
      z-index:-1;
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(2px);
    }

    .wrap{
      width:min(var(--maxw), 100%);
      margin:0 auto;
      padding: calc(var(--pad) + env(safe-area-inset-top)) var(--pad) calc(22px + env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      gap: var(--gap);
      align-items: center;
    }

    /* Header centered */
    .header{
      width:100%;
      background:linear-gradient(180deg, rgba(47,107,255,.18), rgba(47,107,255,.08));
      border: 1px solid rgba(120,160,255,.35);
      border-radius: var(--radius);
      box-shadow: 0 12px 40px rgba(47,107,255,.25);
      backdrop-filter: blur(16px);
      padding: 16px 16px;
      text-align:center;
    }
    .header h1{
      margin:0;
      font-weight: 900;
      letter-spacing: .3px;
      font-size: clamp(22px, 2.8vw, 34px);
      line-height: 1.15;
      text-shadow: 0 10px 35px rgba(0,0,0,.35);
    }

    /* Combined top panel (Setup + Actions + Select Group) */
    .topBar{
      width:100%;
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: clamp(10px, 2vw, 18px);
      flex-wrap:wrap;
    }

    .tabBtn{
      width:auto;
      flex: 0 0 auto;
      padding: 10px 16px;
      height: 42px;

      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: var(--text);

      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;

      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    .tabBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.12); }

    /* Select group inline */
    .labelSmall{
      font-weight: 900;
      letter-spacing:.15px;
      opacity:.9;
      white-space:nowrap;
    }

    select, .input{
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 0 12px;
      outline:none;
      backdrop-filter: blur(10px);
      min-width: 240px;
    }
    .input::placeholder{ color: rgba(255,255,255,.55); }

    /* ‚úÖ dropdown list colors (dark / light) */
    select{ color: var(--text); }
    select option{
      background: rgba(10,12,20,0.98);
      color: rgba(255,255,255,0.92);
    }
    body.light select{ color: rgba(10,12,16,.92); }
    body.light select option{
      background: rgba(255,255,255,0.98);
      color: rgba(10,12,16,.92);
    }

    /* Cards */
    .card{
      width:100%;
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      padding: clamp(14px, 1.7vw, 18px);
    }

    .cardTitle{
      margin:0;
      font-weight: 950;
      letter-spacing: .25px;
      font-size: 16px;
      text-transform: uppercase;
      color: rgba(255,255,255,.88);
      white-space:nowrap;
      text-align:center;
    }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }

    /* Rankings table */
    .tableWrap{
      width:100%;
      margin-top: 12px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 920px;
    }
    th, td{
      padding: 12px 12px;
      white-space:nowrap;
      text-align:center;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 13.5px;
    }
    th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(14px);
      text-transform: uppercase;
      letter-spacing:.22px;
      font-size: 12px;
      color: rgba(255,255,255,.85);
    }
    td.name{
      text-align:left;
      font-weight: 850;
      cursor:pointer;
    }
    /* ‚úÖ Sticky "Name" column (left) */
th.nameCol,
td.name{
  position: sticky;
  left: 0;
  z-index: 3;              /* above normal cells */
}

/* Header cell should be above sticky body cells */
th.nameCol{
  z-index: 6;
}

/* Give sticky column its own background so text stays readable while scrolling */
td.name{
  background: rgba(0,0,0,.28);
  backdrop-filter: blur(14px);
}

/* Sticky header background remains consistent */
th.nameCol{
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(16px);
}

/* Light mode backgrounds for sticky column */
body.light td.name{
  background: rgba(255,255,255,.72);
}
body.light th.nameCol{
  background: rgba(255,255,255,.86);
}

    .total, .rank{ font-weight: 900; }

    .miniBtn{
      height: 34px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: var(--text);
      cursor:pointer;
      font-weight: 850;
      letter-spacing:.1px;
      user-select:none;
      margin: 0 4px;
    }
    .miniBtn:hover{ background: rgba(255,255,255,.16); transform: translateY(-1px); }
    .miniBtn.danger{
      border-color: rgba(255,77,77,.55);
      background: rgba(255,77,77,.18);
    }
    .miniBtn.danger:hover{ background: rgba(255,77,77,.26); }

    /* ‚úÖ smaller race-position dropdowns */
    select.position{
      height: 34px !important;
      border-radius: 12px !important;
      min-width: 64px !important;
      width: 64px !important;
      padding: 0 8px !important;
      font-weight: 800;
    }

    /* Modals */
    .modalBackdrop{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      z-index: 500;
      padding: 14px;
    }

    .modal{
      width: min(820px, 100%);
      max-height: 88vh;
      overflow:auto;
      background: rgba(0,0,0,.24);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 25px 90px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
    }

    .modalInner{
      background: var(--glass);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 16px;
    }

    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    .modalTitle{
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 18px;
      text-transform: uppercase;
    }

    .iconBtn{
      height: 40px;
      width: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      user-select:none;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.14); }

    .btn{
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      transition: transform .15s ease, background .15s ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.16); }
    .btnPrimary{
      border-color: rgba(47,107,255,.55);
      background: linear-gradient(180deg, rgba(47,107,255,.90), rgba(47,107,255,.55));
      box-shadow: 0 10px 30px rgba(47,107,255,.20);
    }
    .btnDanger{
      border-color: rgba(255,77,77,.55);
      background: linear-gradient(180deg, rgba(255,77,77,.80), rgba(255,77,77,.46));
      box-shadow: 0 10px 30px rgba(255,77,77,.16);
    }

    .pbBtn{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: var(--text);
      font-weight: 900;
      letter-spacing:.2px;
      backdrop-filter: blur(10px);
      white-space:nowrap;
    }
    .pbBtn:hover{ background: rgba(255,255,255,.16); transform: translateY(-1px); }

    /* Actions list */
    .actionList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .actionItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
    }
    .actionItem .left{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .actionItem .name{ font-weight: 950; letter-spacing:.15px; }
    .actionItem .desc{ color: var(--muted); font-size: 12.5px; line-height: 1.25; }

    /* Small boxes inside modals */
    .smallBox{
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 14px;
      backdrop-filter: blur(12px);
    }

    .distanceRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      margin-top: 10px;
    }
    .distanceRow input{
      min-width: 120px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 0 10px;
      outline:none;
    }

    /* Confirm popup */
    .confirmBackdrop{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      z-index: 900;
      padding: 14px;
    }
    .confirmBox{
      width:min(420px, 100%);
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 25px 90px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      padding: 14px;
    }
    .confirmBoxInner{
      background: var(--glass);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 14px;
      text-align:center;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      top: 18px;
      transform:translateX(-50%);
      width:min(520px, 92%);
      background: rgba(0,0,0,.72);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 16px;
      padding: 12px 14px;
      color: rgba(255,255,255,.92);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      z-index: 950;
      display:none;
    }

    /* Mobile */
    @media (max-width: 640px){
      .bg{ background-attachment:scroll; }
      .topBar{ justify-content:flex-start; }
      .topBar > *{ flex: 1 1 auto; }
      select, .input{ width:100%; min-width:0; }
    }

    /* Light mode */
    body.light{
      --text: rgba(10,12,16,.92);
      --muted: rgba(10,12,16,.62);

      --glass: rgba(255,255,255,.50);
      --glass2: rgba(255,255,255,.66);
      --stroke: rgba(10,12,16,.10);

      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(47,107,255,.16), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(43,183,255,.12), transparent 55%),
        linear-gradient(180deg, #f6f8ff, #eef3ff);
    }
    body.light .bg{ opacity:.30;filter: saturate(1.08) contrast(1.05); }
    body.light .bgOverlay{ background: rgba(255,255,255,.10); }
    body.light th{ background: rgba(255,255,255,.75); color: rgba(10,12,16,.72); }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="bgOverlay"></div>

  <div class="wrap">

    <div class="header">
      <h1>Ice Skating Short Track Ranking Dashboard</h1>
    </div>

    <!-- ‚úÖ ONE glass panel: Setup + Actions + Select Group -->
    <div class="topBar">
      <button class="tabBtn" id="setupBtn">üßæ Setup</button>
      <button class="tabBtn" id="actionsBtn">‚öôÔ∏è Actions</button>

      <div class="labelSmall">SELECT GROUP</div>
      <select id="viewGroupSelect">
        <option>Alpha</option><option>Bravo</option><option>Charlie</option>
        <option>Delta</option><option>Echo</option><option>Foxtrot</option>
        <option>Golf</option><option>Hotel</option><option>India</option>
        <option>Japan</option><option>Kilo</option><option>London</option>
      </select>
    </div>

    <!-- Rankings -->
    <div class="card">
      <div class="cardTitle">Rankings <br> </div>
      <div style="text-align:center; color:var(--muted); font-size:12.5px; margin-top:10px;">
        Note: These results are for final races only (not heats), and the scores are based on Ontario Short Track Speed Skating guidelines
      </div>

      <div id="excelHeading" style="display:none; text-align:center; margin-top:8px; color:var(--muted); font-size:13px; line-height:1.35;"></div>

      <div class="tableWrap">
        <table id="scoreTable">
          <thead>
            <tr id="headerRow"></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="text-align:center; color:var(--muted); font-size:12.5px; margin-top:10px;">
        Tip: On phones, swipe sideways to view all distances <br>
        Note: You can add skater names manually, edit/add/delete distances, update scores for ranking in "Actions" tab
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- CONFIRM -->
  <div class="confirmBackdrop" id="confirmBackdrop">
    <div class="confirmBox">
      <div class="confirmBoxInner">
        <div style="font-weight:950; letter-spacing:.2px; margin-bottom:8px;">Confirm</div>
        <div id="confirmText" style="color:rgba(255,255,255,.90); line-height:1.5;"></div>
        <div class="row" style="margin-top:12px;">
          <button class="btn" onclick="closeConfirm(false)">Cancel</button>
          <button class="btn btnPrimary" onclick="closeConfirm(true)">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SETUP WINDOW -->
  <div class="modalBackdrop" id="setupModal">
    <div class="modal">
      <div class="modalInner">
        <div class="modalHead">
          <div class="modalTitle">Setup</div>
          <button class="iconBtn" onclick="closeModal('setupModal')">‚úï</button>
        </div>

        <!-- Panel 1: Excel Upload -->
        <div class="smallBox">
          <div style="font-weight:900; margin-bottom:10px;">Excel Upload</div>
          <div class="row" style="justify-content:flex-start;">
            <input class="input" type="file" id="excelFile" accept=".xls,.xlsx" />
            <button class="btn btnPrimary" type="button" onclick="uploadExcel()">‚¨ÜÔ∏è Upload Excel</button>
          </div>
        </div>

        <!-- Panel 2: Manual Entry -->
        <div class="smallBox" style="margin-top:12px;">
          <div style="font-weight:900; margin-bottom:10px;">Manual Entry</div>
          <div class="row" style="justify-content:flex-start;">
            <input class="input" id="skaterName" placeholder="Manually enter the skater name" />
            <select id="addGroupSelect">
              <option>Alpha</option><option>Bravo</option><option>Charlie</option>
              <option>Delta</option><option>Echo</option><option>Foxtrot</option>
              <option>Golf</option><option>Hotel</option><option>India</option>
              <option>Japan</option><option>Kilo</option><option>London</option>
            </select>
            <button class="btn btnPrimary" type="button" onclick="addManual()">‚ûï Add</button>
          </div>
        </div>

        <!-- Bottom buttons -->
        <div class="row" style="margin-top:12px; justify-content:center;">
          <button class="tabBtn" type="button" id="themeToggleBtn">üåì Theme</button>

          <a class="tabBtn"
             href="https://mandeepkoursardarni.github.io/PB_Tracker/"
             target="_blank"
             rel="noopener noreferrer"
             style="text-decoration:none;">
            üîó PB Tracker
          </a>
        </div>

      </div>
    </div>
  </div>

  <!-- ACTIONS WINDOW -->
  <div class="modalBackdrop" id="actionsModal">
    <div class="modal">
      <div class="modalInner">
        <div class="modalHead">
          <div class="modalTitle">Actions</div>
          <button class="iconBtn" onclick="closeModal('actionsModal')">‚úï</button>
        </div>

        <div class="actionList">
          <div class="actionItem">
            <div class="left">
              <div class="name">‚ûï Add Distance</div>
              <div class="desc">Add a new distance column (duplicates allowed)</div>
            </div>
            <button class="btn btnPrimary" type="button" onclick="openModal('addDistanceModal')">Open</button>
          </div>

          <div class="actionItem">
            <div class="left">
              <div class="name">‚úèÔ∏è Edit / Delete Distance</div>
              <div class="desc">Edit distance labels or delete columns</div>
            </div>
            <button class="btn" type="button" onclick="openManageDistances()">Open</button>
          </div>

          <!-- ‚úÖ NEW: EDIT POINTS -->
          <div class="actionItem">
            <div class="left">
              <div class="name">üéØ Edit Points</div>
              <div class="desc">Customize score values by finishing rank</div>
            </div>
            <button class="btn" type="button" onclick="openPointsEditor()">Open</button>
          </div>

          <div class="actionItem">
            <div class="left">
              <div class="name">üóëÔ∏è Reset Present Group</div>
              <div class="desc">Clear current group data</div>
            </div>
            <button class="btn btnDanger" type="button" onclick="resetGroup()">Reset</button>
          </div>

          <div class="actionItem">
            <div class="left">
              <div class="name">üßπ Reset All Groups</div>
              <div class="desc">Clear everything (also resets distances)</div>
            </div>
            <button class="btn btnDanger" type="button" onclick="resetAll()">Reset</button>
          </div>

          <div class="actionItem">
            <div class="left">
              <div class="name">‚ùì Help</div>
              <div class="desc">How to use this dashboard</div>
            </div>
            <button class="btn" type="button" onclick="openModal('helpModal')">Open</button>
          </div>

          <div class="actionItem">
            <div class="left">
              <div class="name">üéÅ Donate</div>
              <div class="desc">Support via PayPal</div>
            </div>
            <button class="btn" type="button" onclick="openModal('donateModal')">Open</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ADD DISTANCE -->
  <div class="modalBackdrop" id="addDistanceModal">
    <div class="modal">
      <div class="modalInner">
        <div class="modalHead">
          <div class="modalTitle">Add Distance</div>
          <button class="iconBtn" onclick="closeModal('addDistanceModal')">‚úï</button>
        </div>

        <div class="smallBox">
          <div style="color:rgba(255,255,255,.90); line-height:1.5;">
            Enter numeric distance (example: 400)
          </div>
          <div class="row" style="margin-top:10px;">
            <input id="newDistanceInput" class="input" placeholder="400" oninput="this.value=this.value.replace(/[^0-9]/g,'');" />
            <button class="btn btnPrimary" onclick="saveNewDistance()">Add</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MANAGE DISTANCES -->
  <div class="modalBackdrop" id="manageDistancesModal">
    <div class="modal">
      <div class="modalInner">
        <div class="modalHead">
          <div class="modalTitle">Edit / Delete Distances</div>
          <button class="iconBtn" onclick="closeModal('manageDistancesModal')">‚úï</button>
        </div>

        <div class="smallBox">
          <div style="color:rgba(255,255,255,.90); line-height:1.5;">
            You can change the numbers or delete rows. Duplicate values are allowed.
          </div>
          <div id="distancesList"></div>

          <div class="row" style="margin-top:12px;">
            <button class="btn btnPrimary" onclick="saveManagedDistances()">Save</button>
            <button class="btn" onclick="closeModal('manageDistancesModal')">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ NEW: EDIT POINTS MODAL -->
  <div class="modalBackdrop" id="pointsModal">
    <div class="modal">
      <div class="modalInner">
        <div class="modalHead">
          <div class="modalTitle">Edit Points</div>
          <button class="iconBtn" onclick="closeModal('pointsModal')">‚úï</button>
        </div>

        <div class="smallBox">
          <div style="color:rgba(255,255,255,.90); line-height:1.5;">
            Change points for each finishing rank. Higher is better.
          </div>

          <div id="pointsList" style="margin-top:12px;"></div>

          <div class="row" style="margin-top:12px;">
            <button class="btn btnPrimary" onclick="savePoints()">Save</button>
            <button class="btn" onclick="restoreDefaultPoints()">Restore Defaults</button>
            <button class="btn" onclick="closeModal('pointsModal')">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- HELP -->
  <div class="modalBackdrop" id="helpModal">
    <div class="modal">
      <div class="modalInner">
        <div class="modalHead">
          <div class="modalTitle">Help</div>
          <button class="iconBtn" onclick="closeModal('helpModal')">‚úï</button>
        </div>

        <div class="smallBox" style="line-height:1.65;">
<div>üìÑ Start by uploading the official Excel file with clubs and divisions</div>
<div>‚úèÔ∏è You can also add skaters manually and choose the group</div>

<div style="margin-top:10px;">üèÖ Select each skater‚Äôs <b>race position</b> for a distance</div>
<div>‚ú® Scores are calculated from the selected race positions</div>

<div style="margin-top:10px;">
  üìä The <b>Rank</b> column shows the skater‚Äôs overall position based on total score  
</div>
<div style="font-size:12.5px; opacity:.9;">
  (This rank may differ from individual race positions if there are gaps or undo actions)
</div>

<div style="margin-top:10px;">‚öôÔ∏è Use <b>Actions</b> to add, edit, or delete distances</div>

<div style="margin-top:10px;">üìå You can switch groups anytime ‚Äî each group is tracked separately</div>
<div>üìå All data is stored <b>locally on your device</b>; nothing is uploaded or shared</div>

<div style="margin-top:10px;">‚Ü©Ô∏è <b>Undo</b> reverts the most recent position change for that skater</div>

<div style="margin-top:10px;">üóëÔ∏è <b>Reset Present Group</b> clears only the selected group</div>
<div>üßπ <b>Reset All Groups</b> clears all groups and restores default distances</div>

<div style="margin-top:10px;">
  üîó <b>PB Tracker</b> is a separate tool for tracking personal bests across seasons and years
</div>

          <div style="margin-top:12px; text-align:center; color:rgba(255,255,255,.90); font-weight:900;">
            üíô All the Best üíô
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DONATE -->
  <div class="modalBackdrop" id="donateModal">
    <div class="modal">
      <div class="modalInner">
        <div class="modalHead">
          <div class="modalTitle">Donate</div>
          <button class="iconBtn" onclick="closeModal('donateModal')">‚úï</button>
        </div>

        <div class="smallBox" style="text-align:center;">
          <div style="color:rgba(255,255,255,.92); line-height:1.5;">
            If this dashboard helps you, you can support it via PayPal üíô
          </div>

          <div class="row" style="margin-top:12px;">
            <a class="pbBtn" href="https://www.paypal.me/MandeepSardarni/2" target="_blank" rel="noopener noreferrer">$2</a>
            <a class="pbBtn" href="https://www.paypal.me/MandeepSardarni/5" target="_blank" rel="noopener noreferrer">$5</a>
            <a class="pbBtn" href="https://www.paypal.me/MandeepSardarni/10" target="_blank" rel="noopener noreferrer">$10</a>
            <a class="pbBtn" href="https://www.paypal.me/MandeepSardarni" target="_blank" rel="noopener noreferrer">Custom</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT NAME -->
  <div class="modalBackdrop" id="editNameModal">
    <div class="modal">
      <div class="modalInner">
        <div class="modalHead">
          <div class="modalTitle">Edit Name</div>
          <button class="iconBtn" onclick="closeModal('editNameModal')">‚úï</button>
        </div>

        <div class="smallBox">
          <div class="row">
            <input id="editNameInput" class="input" placeholder="Enter new name" />
            <button class="btn btnPrimary" onclick="saveEditedName()">Save</button>
            <button class="btn" onclick="closeModal('editNameModal')">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==================================================
   TOAST + THEME
=================================================== */
function toast(msg, ms=2600){
  const t=document.getElementById('toast');
  t.textContent = msg;
  t.style.display='block';
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display='none', ms);
}

function applySavedTheme(){
  const th = localStorage.getItem("theme") || "dark";
  if(th === "light") document.body.classList.add("light");
  else document.body.classList.remove("light");
}
applySavedTheme();

document.getElementById('themeToggleBtn').addEventListener('click', () => {
  document.body.classList.toggle('light');
  localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
});

/* ==================================================
   MODALS
=================================================== */
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }

["setupModal","actionsModal","addDistanceModal","manageDistancesModal","pointsModal","helpModal","donateModal","editNameModal"]
.forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener('click', (e)=>{ if(e.target.id===id) closeModal(id); });
});

document.getElementById('setupBtn').addEventListener('click', ()=>openModal('setupModal'));
document.getElementById('actionsBtn').addEventListener('click', ()=>openModal('actionsModal'));

/* ==================================================
   CONFIRM
=================================================== */
let confirmCallback = null;
function showConfirm(message, cb){
  confirmCallback = cb;
  document.getElementById('confirmText').textContent = message;
  document.getElementById('confirmBackdrop').style.display='flex';
}
function closeConfirm(result){
  document.getElementById('confirmBackdrop').style.display='none';
  if(confirmCallback) confirmCallback(result);
  confirmCallback = null;
}
document.getElementById('confirmBackdrop').addEventListener('click', (e)=>{
  if(e.target.id==='confirmBackdrop') closeConfirm(false);
});

/* ==================================================
   DATA MODEL
=================================================== */
const groupNames = ["Alpha","Bravo","Charlie","Delta","Echo","Foxtrot","Golf","Hotel","India","Japan","Kilo","London"];
const validGroups = groupNames.map(g=>g.toUpperCase());

/* ‚úÖ DEFAULT POINTS + USER-EDITABLE POINTS (saved on device) */
const defaultPoints = {
  1:1000,2:816,3:666,4:543,5:443,
  6:362,7:295,8:241,9:196,10:160,
  11:130,12:106,13:86,14:70,15:57
};

function loadPoints(){
  try{
    const saved = JSON.parse(localStorage.getItem("pointsMap") || "null");
    if(saved && typeof saved === "object") return saved;
  }catch(e){}
  return {...defaultPoints};
}
let points = loadPoints();

function savePointsToStorage(){
  localStorage.setItem("pointsMap", JSON.stringify(points));
}
function restorePointsToDefault(){
  points = {...defaultPoints};
  savePointsToStorage();
}

/* ‚úÖ defaults changed to your new set */
const defaultDistances = ["400","500","800","1000"];
let distances = JSON.parse(localStorage.getItem("distances") || "null") || [...defaultDistances];

let groups = {};
groupNames.forEach(g=>groups[g]={skaters:[], history:{}});

function safeLoad(){
  if(localStorage.getItem("groupsData")){
    try{
      const parsed = JSON.parse(localStorage.getItem("groupsData"));
      if(parsed && typeof parsed === "object"){
        groups = parsed;
        groupNames.forEach(g=>{
          if(!groups[g]) groups[g]={skaters:[], history:{}};
          if(!groups[g].skaters) groups[g].skaters=[];
          if(!groups[g].history) groups[g].history={};
        });
      }
    }catch(e){
      console.warn("Bad groupsData, resetting", e);
      groupNames.forEach(g=>groups[g]={skaters:[], history:{}});
      saveData();
    }
  }
}
safeLoad();

let currentGroup = (localStorage.getItem("currentGroup") || "Alpha");
if(!groupNames.includes(currentGroup)) currentGroup="Alpha";

function saveData(){
  localStorage.setItem("groupsData", JSON.stringify(groups));
  localStorage.setItem("currentGroup", currentGroup);
}
function saveDistances(){
  localStorage.setItem("distances", JSON.stringify(distances));
}

function isName(x){
  if(!x || typeof x!=="string") return false;
  x=x.trim();
  if(x.length<2) return false;
  if(/[^A-Za-z√Ä-√ø '-]/.test(x)) return false;
  return true;
}

/* ==================================================
   GROUP SWITCH
=================================================== */
const viewSel = document.getElementById("viewGroupSelect");
viewSel.value = currentGroup;
viewSel.addEventListener("change", ()=>{
  currentGroup = viewSel.value;
  saveData();
  loadGroupTable();
});

/* ==================================================
   POINTS EDITOR
=================================================== */
function openPointsEditor(){
  renderPointsEditor();
  openModal("pointsModal");
}

function renderPointsEditor(){
  const box = document.getElementById("pointsList");
  const maxRank = 15;
  let html = "";

  for(let r=1; r<=maxRank; r++){
    const val = (points[r] ?? 0);
    html += `
      <div class="distanceRow">
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="font-weight:950; opacity:.9; width:86px;">Rank ${r}</div>
          <input type="text"
                 value="${String(val)}"
                 data-rank="${r}"
                 oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                 style="min-width:140px;" />
        </div>
      </div>
    `;
  }

  box.innerHTML = html;
}

function savePoints(){
  const inputs = document.querySelectorAll("#pointsList input[data-rank]");
  const newMap = {};
  inputs.forEach(inp=>{
    const r = Number(inp.dataset.rank);
    const v = Number((inp.value || "0").trim());
    newMap[r] = Number.isFinite(v) ? v : 0;
  });

  points = newMap;
  savePointsToStorage();
  closeModal("pointsModal");
  updateScores();
  toast("Points saved.");
}

function restoreDefaultPoints(){
  showConfirm("Restore default points values?", (yes)=>{
    if(!yes) return;
    restorePointsToDefault();
    renderPointsEditor();
    updateScores();
    toast("Default points restored.");
  });
}

/* ==================================================
   DISTANCE DUPLICATES SUPPORT
=================================================== */
function escRe(s){
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}
function baseRe(base){
  return new RegExp("^" + escRe(base) + "(\\s\\(\\d+\\))?$");
}
function makeUniqueDistanceLabel(base){
  base = String(base).trim();
  const re = baseRe(base);
  const count = distances.filter(d => re.test(d)).length;
  return count === 0 ? base : `${base} (${count + 1})`;
}

/* ==================================================
   TABLE BUILD
=================================================== */
function buildHeaderRow(){
  const row = document.getElementById("headerRow");
  row.innerHTML = "<th class='nameCol' style='text-align:left;'>Name</th>";
;
  distances.forEach(d=>{
    row.innerHTML += `<th>${escapeHtml(d)}</th>`;
  });
  row.innerHTML += "<th>Total</th><th>Rank</th><th>Undo / Delete</th>";
}

function createDropdown(name, dist){
  const dd = document.createElement("select");
  dd.className="position";
  dd.setAttribute("data-dist", dist);

  dd.innerHTML = `<option value="">-</option>`;
  const count = groups[currentGroup].skaters.length;
  for(let i=1;i<=count;i++) dd.innerHTML += `<option value="${i}">${i}</option>`;

  dd.onchange = ()=>{
    const prevVal = dd.getAttribute("data-last") || "";
    const newVal = dd.value;

    if(!groups[currentGroup].history[name]){
      groups[currentGroup].history[name] = { stack: [] };
    }
    if(!groups[currentGroup].history[name].stack){
      groups[currentGroup].history[name].stack = [];
    }

    groups[currentGroup].history[name].stack.push({ dist, prev: prevVal, current: newVal });

    dd.setAttribute("data-last", newVal);
    updateScores();
    saveData();
  };
  return dd;
}

function rebuildDropdowns(){
  const count = groups[currentGroup].skaters.length;
  document.querySelectorAll("select.position").forEach(dd=>{
    const old = dd.value;
    dd.innerHTML = `<option value="">-</option>`;
    for(let i=1;i<=count;i++) dd.innerHTML += `<option value="${i}">${i}</option>`;
    dd.value = old;
  });
}

function loadGroupTable(){
  buildHeaderRow();
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = "";

  const groupData = groups[currentGroup];

  groupData.skaters.forEach(n=>{
    if(!groupData.history[n]) groupData.history[n] = { stack: [] };
    if(!groupData.history[n].stack) groupData.history[n].stack = [];
  });

  groupData.skaters.forEach(name=>{
    const tr = document.createElement("tr");
    tr.dataset.name = name;

    let html = `<td class="name" onclick="openEditName('${escapeQuotes(name)}')">${escapeHtml(name)}</td>`;
    distances.forEach(()=>{ html += "<td></td>"; });

    html += `
      <td class="total">0</td>
      <td class="rank">-</td>
      <td>
        <button class="miniBtn danger" onclick="undo('${escapeQuotes(name)}')">Undo</button>
        <button class="miniBtn danger" onclick="deleteSkater('${escapeQuotes(name)}')">Delete</button>
      </td>
    `;
    tr.innerHTML = html;

    distances.forEach((dist, i)=>{
      const cell = tr.children[i+1];
      const dd = createDropdown(name, dist);
      cell.appendChild(dd);
    });

    tbody.appendChild(tr);
  });

  rebuildDropdowns();

  // restore last values per distance
  groupData.skaters.forEach(name=>{
    const row = document.querySelector(`tr[data-name="${cssEscape(name)}"]`);
    const h = groupData.history[name];
    distances.forEach(dist=>{
      const dd = row.querySelector(`select[data-dist="${cssEscape(dist)}"]`);
      if(!dd) return;
      const stack = h.stack || [];
      const last = [...stack].reverse().find(s=>s.dist===dist);
      const v = (last && last.current !== undefined) ? last.current : "";
      dd.value = v;
      dd.setAttribute("data-last", v);
    });
  });

  updateScores();
}

/* ==================================================
   SCORE + SORT + MEDALS
=================================================== */
function updateScores(){
  const tbody = document.querySelector("#scoreTable tbody");
  const rows = [...tbody.querySelectorAll("tr")];

  rows.forEach(row=>{
    let total=0;
    row.querySelectorAll("select.position").forEach(dd=>{
      const pos = Number(dd.value);
      if(points[pos]) total += points[pos];
    });
    row.querySelector(".total").textContent = total;
  });

  const scored = rows.filter(r=>Number(r.querySelector(".total").textContent)>0);
  const unscored = rows.filter(r=>Number(r.querySelector(".total").textContent)===0);

  scored.sort((a,b)=>
    Number(b.querySelector(".total").textContent) -
    Number(a.querySelector(".total").textContent)
  );

  tbody.innerHTML="";
  scored.forEach(r=>tbody.appendChild(r));
  unscored.forEach(r=>tbody.appendChild(r));

  scored.forEach((row,index)=>{
    const rank=index+1;
    const nm=row.dataset.name;
    const cell=row.querySelector(".name");

    if(rank===1) cell.innerHTML = "ü•á " + escapeHtml(nm);
    else if(rank===2) cell.innerHTML = "ü•à " + escapeHtml(nm);
    else if(rank===3) cell.innerHTML = "ü•â " + escapeHtml(nm);
    else cell.innerHTML = escapeHtml(nm);

    row.querySelector(".rank").textContent=rank;
  });

  unscored.forEach(r=>{
    r.querySelector(".name").innerHTML = escapeHtml(r.dataset.name);
    r.querySelector(".rank").textContent="-";
  });
}

/* ==================================================
   UNDO / DELETE / EDIT NAME
=================================================== */
function undo(name){
  const h = groups[currentGroup].history[name];
  if(!h || !h.stack || h.stack.length===0) return;

  const last = h.stack.pop();
  const dist = last.dist;
  const prev = (last.prev ?? "");

  const row = document.querySelector(`tr[data-name="${cssEscape(name)}"]`);
  if(!row) return;
  const dd = row.querySelector(`select[data-dist="${cssEscape(dist)}"]`);
  if(!dd) return;

  dd.value = prev;
  dd.setAttribute("data-last", prev);

  updateScores();
  saveData();
}

function deleteSkater(name){
  showConfirm(`Delete "${name}" from ${currentGroup}?`, (yes)=>{
    if(!yes) return;

    groups[currentGroup].skaters = groups[currentGroup].skaters.filter(n=>n!==name);
    if(groups[currentGroup].history[name]) delete groups[currentGroup].history[name];

    saveData();
    loadGroupTable();
  });
}

let nameBeingEdited = null;
function openEditName(name){
  nameBeingEdited = name;
  document.getElementById("editNameInput").value = name;
  openModal("editNameModal");
}

function saveEditedName(){
  const newName = document.getElementById("editNameInput").value.trim();
  if(!newName) return;

  if(groups[currentGroup].skaters.includes(newName) && newName !== nameBeingEdited){
    toast("That name already exists in this group.");
    return;
  }

  const g = groups[currentGroup];
  const idx = g.skaters.indexOf(nameBeingEdited);
  if(idx !== -1) g.skaters[idx] = newName;

  g.history[newName] = g.history[nameBeingEdited] || { stack: [] };
  delete g.history[nameBeingEdited];

  saveData();
  closeModal("editNameModal");
  loadGroupTable();
}

/* ==================================================
   ADD SKATER (MANUAL)
=================================================== */
function addSkaterToGroup(name, group){
  name = name.replace(/[0-9]/g,"").replace(/\s+/g," ").trim();
  if(!name) return;

  const G = groups[group];
  if(!G.skaters.includes(name)){
    G.skaters.push(name);
    if(!G.history[name]) G.history[name] = { stack: [] };
    if(!G.history[name].stack) G.history[name].stack = [];
  }

  saveData();
  if(group === currentGroup) loadGroupTable();
}

function addManual(){
  const name = document.getElementById("skaterName").value.trim();
  if(!name) return;

  const group = document.getElementById("addGroupSelect").value;
  addSkaterToGroup(name, group);
  document.getElementById("skaterName").value = "";
}

/* ==================================================
   RESET
=================================================== */
function resetGroup(){
  showConfirm(`Reset the ${currentGroup} group?`, (yes)=>{
    if(!yes) return;
    groups[currentGroup] = { skaters: [], history: {} };
    saveData();
    loadGroupTable();
  });
}

function resetAll(){
  showConfirm("Reset ALL groups and restore default distances?", (yes)=>{
    if(!yes) return;

    groupNames.forEach(g=>groups[g]={skaters:[], history:{}});
    distances = [...defaultDistances];
    saveDistances();

    /* ‚úÖ also restore points to default on Reset All */
    restorePointsToDefault();

    saveData();
    loadGroupTable();
  });
}

/* ==================================================
   DISTANCES (ADD / EDIT / DELETE)  ‚úÖ duplicates allowed
=================================================== */
function saveNewDistance(){
  const base = (document.getElementById("newDistanceInput").value || "").trim();
  if(!base){ toast("Enter a distance (numbers only)."); return; }

  const re = baseRe(base);
  const exists = distances.some(d => re.test(d));

  const doAdd = () => {
    const label = makeUniqueDistanceLabel(base);
    distances.push(label);
    saveDistances();

    document.getElementById("newDistanceInput").value = "";
    closeModal("addDistanceModal");

    loadGroupTable();
    toast(`Distance ${label} added.`);
  };

  if(exists){
    showConfirm(`"${base}" already exists. Add another ${base}?`, (yes)=>{
      if(!yes) return;
      doAdd();
    });
  }else{
    doAdd();
  }
}

function openManageDistances(){
  const list = document.getElementById("distancesList");
  list.innerHTML = "";

  distances.forEach((d, idx)=>{
    const row = document.createElement("div");
    row.className = "distanceRow";
    row.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="font-weight:900; opacity:.9;">#${idx+1}</div>
        <input type="text" value="${escapeHtml(d)}" data-index="${idx}"
               oninput="this.value=this.value.replace(/[^0-9 ()]/g,'');" />
      </div>
      <button class="btn btnDanger" style="height:40px;" onclick="deleteDistance(${idx})">Delete</button>
    `;
    list.appendChild(row);
  });

  openModal("manageDistancesModal");
}

function deleteDistance(idx){
  distances.splice(idx, 1);
  if(distances.length === 0) distances = [...defaultDistances];
  saveDistances();
  openManageDistances();
}

function saveManagedDistances(){
  const inputs = document.querySelectorAll("#distancesList input");
  let raw = [];
  inputs.forEach(inp=>{
    const v = inp.value.trim();
    if(v) raw.push(v);
  });

  if(raw.length === 0){
    toast("At least one distance required. Restoring defaults.");
    raw = [...defaultDistances];
  }

  // Normalize duplicates into (2), (3)...
  const used = {};
  const normalized = raw.map(v=>{
    const base = String(v).trim().match(/^(\d+)/)?.[1] || String(v).trim();
    used[base] = (used[base] || 0) + 1;
    return used[base] === 1 ? base : `${base} (${used[base]})`;
  });

  distances = normalized;
  saveDistances();

  closeModal("manageDistancesModal");
  loadGroupTable();
  toast("Distances saved.");
}

/* ==================================================
   EXCEL UPLOAD function
=================================================== */

function uploadExcel(){
  const file = document.getElementById("excelFile").files[0];
  if(!file){ toast("Please choose an Excel file."); return; }

  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});

      const sheetNames = ["Club","Clubs","Divisions"];
      let headingText = "";

      for(const s of sheetNames){
        const sh = workbook.Sheets[s];
        if(!sh) continue;
        const a1 = sh["A1"] ? String(sh["A1"].v).trim() : "";
        if(a1.length > 10){ headingText = a1; break; }
      }

      const headingEl = document.getElementById("excelHeading");
      if(headingText){
        headingEl.textContent = headingText;
        headingEl.style.display = "block";
      } else {
        headingEl.style.display = "none";
      }

      const sheet = workbook.Sheets["Divisions"];
      if(!sheet){
        toast("Excel format not expected (missing 'Divisions' sheet).");
        return;
      }

      const rows = XLSX.utils.sheet_to_json(sheet, {header:1});

      // ‚úÖ Start with current group as fallback so early rows never get skipped
      let detectedGroup = currentGroup;

      // ‚úÖ Track unique additions (prevents double counting)
      const addedKeys = new Set();
      let addedCount = 0;

      // helper: normalize
      const norm = (v)=> (v===undefined || v===null) ? "" : String(v).trim();

      // ‚úÖ helper: allow multi-part last names by reading extra columns
      function buildNameFromRow(row){
        // Your original source columns:
        // first name often around B/C/D and last around C/D/E
        const c1 = norm(row[1]);
        const c2 = norm(row[2]);
        const c3 = norm(row[3]);
        const c4 = norm(row[4]);
        const c5 = norm(row[5]); // ‚úÖ extra spillover support
        const c6 = norm(row[6]); // ‚úÖ extra spillover support

        // Skip header-ish rows
        const combined = ( [c1,c2,c3,c4].join(" ").toUpperCase() ).replace(/\s+/g," ").trim();
        const headerBlacklist = ["FIRST","LAST","FULL","NAME","SKATER","ATHLETE","COMPETITOR","PARTICIPANT"];
        if(headerBlacklist.some(h=>combined.includes(h))) return null;

        // ‚úÖ case 1: First in c1, last begins at c2 and may continue into c3/c4...
        if(isName(c1) && isName(c2)){
          let lastParts = [c2];

          // include extra parts if they look like name parts (spaces/hyphen/apostrophe)
          // NOTE: use your isName() for each part if you want strictness; this is safer:
          const extra = [c3,c4,c5,c6];
          for(const p of extra){
            if(!p) break;
            // stop if it looks like a non-name token
            if(/[^A-Za-z√Ä-√ø '\-]/.test(p)) break;
            lastParts.push(p);
          }
          return (c1 + " " + lastParts.join(" ")).replace(/\s+/g," ").trim();
        }

        // ‚úÖ case 2: shifted by one column
        if(isName(c2) && isName(c3)){
          let lastParts = [c3];
          const extra = [c4,c5,c6];
          for(const p of extra){
            if(!p) break;
            if(/[^A-Za-z√Ä-√ø '\-]/.test(p)) break;
            lastParts.push(p);
          }
          return (c2 + " " + lastParts.join(" ")).replace(/\s+/g," ").trim();
        }

        // ‚úÖ case 3: shifted again
        if(isName(c3) && isName(c4)){
          let lastParts = [c4];
          const extra = [c5,c6];
          for(const p of extra){
            if(!p) break;
            if(/[^A-Za-z√Ä-√ø '\-]/.test(p)) break;
            lastParts.push(p);
          }
          return (c3 + " " + lastParts.join(" ")).replace(/\s+/g," ").trim();
        }

        return null;
      }

      // ‚úÖ group detection: still uses column H, but also checks nearby cells
      function detectGroupFromRow(row){
        // prefer your original column H first
        const candidates = [row[7], row[6], row[8]]; // a bit more tolerant
        for(const c of candidates){
          if(typeof c === "string"){
            const G = c.trim().toUpperCase();
            if(validGroups.includes(G)){
              return G.charAt(0) + G.slice(1).toLowerCase();
            }
          }
        }
        return null;
      }

      for(let r=0; r<rows.length; r++){
        const row = rows[r];
        if(!row) continue;

        // update detectedGroup if we see a marker
        const g = detectGroupFromRow(row);
        if(g){
          detectedGroup = g;
          continue;
        }

        const name = buildNameFromRow(row);
        if(name){
          const clean = name.replace(/[0-9]/g,"").replace(/\s+/g," ").trim();
          const key = detectedGroup + "||" + clean;

          if(!addedKeys.has(key)){
            addedKeys.add(key);
            addSkaterToGroup(clean, detectedGroup);
            addedCount++;
          }
        }
      }

      if(addedCount === 0){
        toast("Excel looks glitchy or not in expected format. Try again or add names manually.");
      }else{
        saveData();
        loadGroupTable();
        toast(`Added ${addedCount} skaters across groups.`);
      }

    }catch(err){
      console.error(err);
      toast("Could not read this Excel file. Try a different file.");
    }
  };
  reader.readAsArrayBuffer(file);
}



/* ==================================================
   UTILS
=================================================== */
function escapeQuotes(s){
  return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'");
}
function escapeHtml(s){
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function cssEscape(s){
  return String(s).replace(/"/g,'\\"');
}

/* ==================================================
   INITIAL LOAD
=================================================== */
loadGroupTable();
</script>

</body>
</html>
